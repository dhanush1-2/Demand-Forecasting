# Demand Forecasting & Business Planning

A production-ready demand forecasting solution with Prophet and XGBoost models, Flask REST API, and Power BI integration.

## Features

- **Synthetic Data Generation**: Realistic daily sales data with trends, seasonality, and promotional effects
- **Weekly Aggregation**: Reduces noise for more stable forecasts
- **Dual Models**: Prophet for seasonality + XGBoost for feature-rich predictions
- **Flask API**: RESTful endpoints for real-time predictions
- **Power BI Ready**: CSV exports for easy visualization
- **Docker Support**: Containerized deployment

## Project Structure

```
demand-forecast/
├─ data/
│  └─ sample_data.csv         # Generated by src/generate_data.py
├─ notebooks/
│  └─ quick_explore.ipynb     # Exploratory analysis
├─ src/
│  ├─ generate_data.py        # Synthetic data generator
│  ├─ data_prep.py            # Load & resample to weekly
│  ├─ features.py             # Lag features for XGBoost
│  ├─ train_prophet.py        # Train & save Prophet model
│  ├─ train_xgboost.py        # Train & save XGBoost model
│  ├─ evaluate.py             # Export forecasts to CSV
│  └─ app.py                  # Flask prediction API
├─ outputs/                   # CSV forecasts for Power BI
├─ models/                    # Saved .joblib models
├─ Dockerfile
├─ requirements.txt
└─ README.md
```

## Quick Start

### 1. Generate Sample Data

```bash
python src/generate_data.py
```

Creates `data/sample_data.csv` with ~3 years of daily sales (columns: `ds`, `y`, `promo`, `store_id`)

### 2. Train Models

```bash
# Train Prophet model
python src/train_prophet.py

# Train XGBoost model
python src/train_xgboost.py
```

Models are saved to `models/` as `.joblib` files.

### 3. Evaluate & Export for Power BI

```bash
python src/evaluate.py
```

Outputs CSV files to `outputs/`:
- `prophet_forecast.csv` - Prophet predictions
- `xgb_forecast.csv` - XGBoost predictions

**Import these CSVs into Power BI** to build dashboards with actual vs predicted visualizations.

### 4. Run Flask API

```bash
# Development mode
python src/app.py

# Production mode (recommended)
gunicorn -b 0.0.0.0:5000 src.app:app --workers=2 --timeout=120
```

API available at `http://localhost:5000`

## API Endpoints

### `GET /`
Returns API info

### `GET /predict?model=prophet&horizon_weeks=12`
Returns forecast predictions

**Query Parameters:**
- `model` - `prophet` or `xgb` (default: `prophet`)
- `horizon_weeks` - Number of weeks to forecast (default: `12`)

**Example:**
```bash
curl "http://localhost:5000/predict?model=xgb&horizon_weeks=8"
```

**Response:**
```json
{
  "model": "xgb",
  "predictions": [
    {"ds": "2024-12-02", "y_pred": 387.52},
    {"ds": "2024-12-09", "y_pred": 395.18},
    ...
  ]
}
```

## Docker Deployment

```bash
# Build image
docker build -t demand-forecast .

# Run container
docker run -p 5000:5000 demand-forecast
```

Access API at `http://localhost:5000`

## Power BI Integration

1. **Generate forecasts:**
   ```bash
   python src/evaluate.py
   ```

2. **In Power BI Desktop:**
   - Get Data → Text/CSV
   - Load `outputs/prophet_forecast.csv` and/or `outputs/xgb_forecast.csv`
   - Create visualizations:
     - Line chart: `ds` (x-axis) vs `y` and `yhat` (y-axis)
     - KPI cards: MAE, RMSE metrics
     - Slicers: Date range filters

3. **Refresh data:**
   - Re-run `evaluate.py` to update CSVs
   - Click "Refresh" in Power BI to reload

## Model Details

### Prophet
- **Input:** Weekly aggregated data with `promo` regressor
- **Captures:** Weekly/yearly seasonality, promotional spikes
- **Use case:** Long-term forecasts (3-12 months)
- **Output:** Predictions with confidence intervals

### XGBoost
- **Features:** Lags (1,2,3,4,8,12 weeks), rolling mean, day-of-week, month, promo flag
- **Training:** Early stopping on validation set
- **Use case:** Short-term forecasts (1-3 months)
- **Output:** Point predictions with feature importance

## Customization

### Use Your Own Data

Replace `data/sample_data.csv` with your CSV containing:
- `ds` - Date column (YYYY-MM-DD format)
- `y` - Target variable (sales, demand, etc.)
- `promo` - Binary promotional indicator (0/1)

Then re-run training scripts.

### Tune Hyperparameters

**Prophet** (`src/train_prophet.py`):
```python
m = Prophet(
    weekly_seasonality=True,
    yearly_seasonality=True,
    changepoint_prior_scale=0.05  # Adjust trend flexibility
)
```

**XGBoost** (`src/train_xgboost.py`):
```python
params = {
    'eta': 0.1,           # Learning rate
    'max_depth': 6,       # Tree depth
    'num_boost_round': 200  # Number of trees
}
```

## Requirements

```
pandas==2.2.2
numpy==1.26.2
scikit-learn==1.3.2
xgboost==2.1.6
prophet==1.2.1
flask==2.3.2
gunicorn==20.1.0
joblib==1.3.2
matplotlib==3.8.1
```

Install: `pip install -r requirements.txt`

## Jupyter Notebook

Explore data and models interactively:

```bash
jupyter notebook notebooks/quick_explore.ipynb
```

## Workflow

```
1. Generate data  →  src/generate_data.py
2. Train models   →  src/train_prophet.py + src/train_xgboost.py
3. Evaluate       →  src/evaluate.py (outputs CSVs)
4. Visualize      →  Import CSVs to Power BI
5. Deploy API     →  Docker or Gunicorn for production predictions
```

## Troubleshooting

**"Model not found" error:**
- Run training scripts first: `python src/train_prophet.py`

**Import errors:**
- Ensure you're running from repo root (not inside `src/`)
- Check virtual environment is activated

**Power BI won't load CSV:**
- Verify file exists in `outputs/` folder
- Use absolute path in Power BI import

## License

MIT License - free to use and modify.

## Contributing

Pull requests welcome! Please ensure:
- Code follows existing style
- Models train without errors
- CSVs export correctly

## Support

Open an issue on GitHub for questions or bugs.
